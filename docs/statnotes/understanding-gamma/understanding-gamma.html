<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Filippo Gambarota">

<title>Understanding (hopefully) the Gamma distribution</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-4d122a61f78e65151183551a7bff2f4d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://filippogambarota.github.io/cv/" target="_blank"> 
<span class="menu-text">cv</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching.html"> 
<span class="menu-text">teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../statnotes.html"> 
<span class="menu-text">statistics notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../slides.html"> 
<span class="menu-text">slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../coding.html"> 
<span class="menu-text">coding</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Understanding (hopefully) the Gamma distribution</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Filippo Gambarota </p>
            </div>
    </div>
      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#gamma-poisson-and-exponential" id="toc-gamma-poisson-and-exponential" class="nav-link active" data-scroll-target="#gamma-poisson-and-exponential">Gamma, Poisson and Exponential</a>
  <ul class="collapse">
  <li><a href="#poisson-distribution" id="toc-poisson-distribution" class="nav-link" data-scroll-target="#poisson-distribution">Poisson distribution</a></li>
  <li><a href="#exponential-distribution" id="toc-exponential-distribution" class="nav-link" data-scroll-target="#exponential-distribution">Exponential distribution</a></li>
  <li><a href="#gamma-distribution" id="toc-gamma-distribution" class="nav-link" data-scroll-target="#gamma-distribution">Gamma distribution</a>
  <ul class="collapse">
  <li><a href="#shape-alpha-and-rate-lambda-parametrization" id="toc-shape-alpha-and-rate-lambda-parametrization" class="nav-link" data-scroll-target="#shape-alpha-and-rate-lambda-parametrization">Shape <span class="math inline">\(\alpha\)</span> and Rate <span class="math inline">\(\lambda\)</span> parametrization</a></li>
  <li><a href="#shape-alpha-and-scale-theta-parametrization" id="toc-shape-alpha-and-scale-theta-parametrization" class="nav-link" data-scroll-target="#shape-alpha-and-scale-theta-parametrization">Shape <span class="math inline">\(\alpha\)</span> and Scale <span class="math inline">\(\theta\)</span> parametrization</a></li>
  <li><a href="#mu-and-shape-alpha-parametrization" id="toc-mu-and-shape-alpha-parametrization" class="nav-link" data-scroll-target="#mu-and-shape-alpha-parametrization"><span class="math inline">\(\mu\)</span> and shape <span class="math inline">\(\alpha\)</span> parametrization</a></li>
  <li><a href="#mu-and-sigma2-parametrization" id="toc-mu-and-sigma2-parametrization" class="nav-link" data-scroll-target="#mu-and-sigma2-parametrization"><span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma^2\)</span> parametrization</a></li>
  </ul></li>
  <li><a href="#different-packages" id="toc-different-packages" class="nav-link" data-scroll-target="#different-packages">Different packages</a>
  <ul class="collapse">
  <li><a href="#brms" id="toc-brms" class="nav-link" data-scroll-target="#brms"><code>brms</code></a></li>
  <li><a href="#glmglmer" id="toc-glmglmer" class="nav-link" data-scroll-target="#glmglmer"><code>glm/glmer</code></a></li>
  <li><a href="#gamlss" id="toc-gamlss" class="nav-link" data-scroll-target="#gamlss"><code>gamlss</code></a></li>
  </ul></li>
  <li><a href="#note-about-the-link-function" id="toc-note-about-the-link-function" class="nav-link" data-scroll-target="#note-about-the-link-function">Note about the link function</a></li>
  <li><a href="#mean-variance-relationship" id="toc-mean-variance-relationship" class="nav-link" data-scroll-target="#mean-variance-relationship">Mean-Variance relationship</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>gamma_params <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">shape =</span> <span class="cn">NULL</span>, <span class="at">scale =</span> <span class="dv">1</span><span class="sc">/</span>rate, <span class="at">rate =</span> <span class="dv">1</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">mean =</span> <span class="cn">NULL</span>, <span class="at">sd =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">eqs =</span> <span class="cn">FALSE</span>){</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(eqs){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">25</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">eqs</span>()<span class="sc">$</span>gamma, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">rep</span>(<span class="st">"="</span>, <span class="dv">25</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(shape)){</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      var <span class="ot">&lt;-</span> sd<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      shape <span class="ot">&lt;-</span> mean<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> var</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      scale <span class="ot">&lt;-</span> mean <span class="sc">/</span> shape</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      rate <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>scale</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is.null</span>(mean) <span class="sc">&amp;</span> <span class="fu">is.null</span>(sd)){</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.null</span>(rate)){</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        scale <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>rate</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span>{</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        rate <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>scale</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>      mean <span class="ot">&lt;-</span> shape <span class="sc">*</span> scale</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>      var <span class="ot">&lt;-</span> shape <span class="sc">*</span> scale<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(var)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"when shape and scale are provided, mean and sd need to be NULL (and viceversa)"</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">shape =</span> shape, <span class="at">scale =</span> scale, <span class="at">rate =</span> rate, <span class="at">mean =</span> mean, <span class="at">var =</span> var, <span class="at">sd =</span> sd)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># coefficient of variation</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    out<span class="sc">$</span>cv <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(shape)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(out)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>gammap <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">mean =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sd =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>                   <span class="at">shape =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">scale =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>                   <span class="at">rate =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>                   <span class="at">skew =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>                   <span class="at">cv =</span> <span class="cn">NULL</span>){</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    pars <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">environment</span>())</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    spars <span class="ot">&lt;-</span> pars[<span class="sc">!</span><span class="fu">sapply</span>(pars, is.null)]</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    is_pair <span class="ot">&lt;-</span> <span class="cf">function</span>(x, pair){</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">all</span>(x <span class="sc">%in%</span> pair)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    compute <span class="ot">&lt;-</span> <span class="cf">function</span>(shape, scale) {</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        rate <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> scale</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        mean <span class="ot">&lt;-</span> shape <span class="sc">*</span> scale</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(shape <span class="sc">*</span> scale<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        cv <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(shape)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        skew <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">/</span> <span class="fu">sqrt</span>(shape)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(<span class="at">shape =</span> shape, <span class="at">rate =</span> rate, <span class="at">scale =</span> scale, <span class="at">cv =</span> cv, <span class="at">skew =</span> skew, <span class="at">mean =</span> mean, <span class="at">sd =</span> sd)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is_pair</span>(<span class="fu">names</span>(spars), <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"sd"</span>))){</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        mean <span class="ot">&lt;-</span> spars<span class="sc">$</span>mean</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        sd <span class="ot">&lt;-</span> spars<span class="sc">$</span>sd</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        cv <span class="ot">&lt;-</span> sd<span class="sc">/</span>mean</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        shape <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> cv<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        scale <span class="ot">&lt;-</span> mean <span class="sc">/</span> shape</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is_pair</span>(<span class="fu">names</span>(spars), <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"shape"</span>))){</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        mean <span class="ot">&lt;-</span> spars<span class="sc">$</span>mean</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        shape <span class="ot">&lt;-</span> spars<span class="sc">$</span>shape</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        scale <span class="ot">&lt;-</span> mean <span class="sc">/</span> shape</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is_pair</span>(<span class="fu">names</span>(spars), <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"cv"</span>))){</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>        mean <span class="ot">&lt;-</span> spars<span class="sc">$</span>mean</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        cv <span class="ot">&lt;-</span> spars<span class="sc">$</span>cv</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>        shape <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> cv<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>        scale <span class="ot">&lt;-</span> mean <span class="sc">*</span> cv<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is_pair</span>(<span class="fu">names</span>(spars), <span class="fu">c</span>(<span class="st">"shape"</span>, <span class="st">"rate"</span>))){</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        shape <span class="ot">&lt;-</span> spars<span class="sc">$</span>shape</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        scale <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>spars<span class="sc">$</span>rate</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span> <span class="cf">if</span>(<span class="fu">is_pair</span>(<span class="fu">names</span>(spars), <span class="fu">c</span>(<span class="st">"shape"</span>, <span class="st">"scale"</span>))){</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        shape <span class="ot">&lt;-</span> spars<span class="sc">$</span>shape</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        scale <span class="ot">&lt;-</span> spars<span class="sc">$</span>scale</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"combination not implemented!"</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">compute</span>(shape, scale)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>ggamma <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">shape =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>                   <span class="at">scale =</span> <span class="dv">1</span><span class="sc">/</span>rate,</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>                   <span class="at">rate =</span> <span class="dv">1</span>,</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>                   <span class="at">mean =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sd =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>                   <span class="at">show =</span> <span class="fu">c</span>(<span class="st">"msd"</span>, <span class="st">"sr"</span>, <span class="st">"ss"</span>),</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>                   <span class="at">lf =</span> <span class="dv">5</span>,</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size =</span> <span class="dv">15</span>,</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ns =</span> <span class="fl">1e4</span>){</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  show <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(show)</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  argg <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">environment</span>())[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>  gm <span class="ot">&lt;-</span> <span class="fu">do.call</span>(gamma_params, argg)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">sapply</span>(gm, length))) <span class="sc">!=</span> <span class="dv">1</span>){</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"All vectors need to be of the same length!"</span>)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(gm<span class="sc">$</span>mean)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(gm<span class="sc">$</span>mean) <span class="sc">+</span> lf <span class="sc">*</span> <span class="fu">max</span>(gm<span class="sc">$</span>sd))</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">seq</span>(range[<span class="dv">1</span>], range[<span class="dv">2</span>], <span class="at">length.out =</span> ns)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">mapply</span>(<span class="cf">function</span>(sh, sc) <span class="fu">dgamma</span>(x, <span class="at">shape =</span> sh, <span class="at">scale =</span> sc), gm<span class="sc">$</span>shape, gm<span class="sc">$</span>scale, <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  D <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">rep</span>(x, n),</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>                  <span class="at">d =</span> <span class="fu">unlist</span>(d),</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shape =</span> <span class="fu">rep</span>(gm<span class="sc">$</span>shape, <span class="at">each =</span> <span class="fu">length</span>(x)),</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scale =</span> <span class="fu">rep</span>(gm<span class="sc">$</span>scale, <span class="at">each =</span> <span class="fu">length</span>(x)),</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>                  <span class="at">rate =</span> <span class="fu">rep</span>(gm<span class="sc">$</span>rate, <span class="at">each =</span> <span class="fu">length</span>(x)),</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>                  <span class="at">mean =</span> <span class="fu">rep</span>(gm<span class="sc">$</span>mean, <span class="at">each =</span> <span class="fu">length</span>(x)),</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sd =</span> <span class="fu">rep</span>(gm<span class="sc">$</span>sd, <span class="at">each =</span> <span class="fu">length</span>(x))</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(show <span class="sc">==</span> <span class="st">"msd"</span>){</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>    D<span class="sc">$</span>cond <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">mu = %.3f$, $</span><span class="sc">\\</span><span class="st">sigma = %.3f$"</span>, D<span class="sc">$</span>mean, D<span class="sc">$</span>sd))</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(show <span class="sc">==</span> <span class="st">"ss"</span>){</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    D<span class="sc">$</span>cond <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">"$k (shape) = %.3f$, $</span><span class="sc">\\</span><span class="st">theta (scale) = %.3f$"</span>, D<span class="sc">$</span>shape, D<span class="sc">$</span>scale))</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    D<span class="sc">$</span>cond <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">alpha (shape) = %.3f$, $</span><span class="sc">\\</span><span class="st">beta (rate) = %.3f$"</span>, D<span class="sc">$</span>shape, D<span class="sc">$</span>rate))</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(D, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> d, <span class="at">color =</span> cond)) <span class="sc">+</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">lwd =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_discrete</span>(<span class="at">labels =</span> <span class="fu">lapply</span>(<span class="fu">levels</span>(D<span class="sc">$</span>cond), latex2exp<span class="sc">::</span>TeX)) <span class="sc">+</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="fu">c</span>(.<span class="dv">95</span>, .<span class="dv">95</span>),</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"top"</span>),</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.box.just =</span> <span class="st">"right"</span>,</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(latex2exp<span class="sc">::</span><span class="fu">TeX</span>(<span class="st">"dgamma($x$, $</span><span class="sc">\\</span><span class="st">alpha$/$k$, $</span><span class="sc">\\</span><span class="st">theta$, $</span><span class="sc">\\</span><span class="st">beta$)"</span>))</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="gamma-poisson-and-exponential" class="level1">
<h1>Gamma, Poisson and Exponential</h1>
<p>Before the <strong>Gamma</strong> distribution, we can start briefly introducing the <strong>Poisson</strong> and <strong>Exponential</strong> distribution because they are strictly linked.</p>
<p>We can make a little spoiler about the link and then going into details:</p>
<blockquote class="blockquote">
<p>The Poisson distribution represents the rate of discrete events for a fixed period of time (unit time). The exponential distribution is the time that it takes for the first event to happen while the Gamma distribution represents the time taken by <span class="math inline">\(k\)</span> events to happen.</p>
</blockquote>
<p>In fact, even without going into details about the equations, is not a coincidence that all three distributions have one parameter called the rate (usually <span class="math inline">\(\lambda\)</span>).</p>
<section id="poisson-distribution" class="level2">
<h2 class="anchored" data-anchor-id="poisson-distribution">Poisson distribution</h2>
<p>The poisson distribution PMF (probability mass function) is represented in <a href="#eq-poisson-pmf" class="quarto-xref">Equation&nbsp;1</a>.</p>
<p><span id="eq-poisson-pmf"><span class="math display">\[
P(X = k) = \frac{\lambda^k e^{-\lambda}}{k!}
\tag{1}\]</span></span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">1</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="fu">data.frame</span>(x)) <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">xend =</span> x, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> <span class="fu">dpois</span>(x, lambda))) <span class="sc">+</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">tex</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">lambda = 10"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="understanding-gamma_files/figure-html/unnamed-chunk-3-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The mean if the poisson is just <span class="math inline">\(\lambda\)</span> and the variance is still <span class="math inline">\(\lambda\)</span> (thus the standard deviaton is <span class="math inline">\(\sqrt{\lambda}\)</span>). This is also very intuitive because as <span class="math inline">\(\lambda\)</span> decrease, the spread of the distribution decrease because there it is left-bounded on zero. This is a common feature of Exponential, Gamma and Poisson distributions.</p>
<p>An assumption of the Poisson distribution is that <span class="math inline">\(\lambda\)</span> is fixed for every observation and this is the most common limitation that often (if not always) lead to overdispersion, but this is another story.</p>
<p>As a practical example, let’s assume that we are observing the number of cars passing on a certain street during 1 hour. 1 hour is our unit time and <span class="math inline">\(\lambda\)</span> is the average number of cars i.e.&nbsp;the average rate of cars.</p>
</section>
<section id="exponential-distribution" class="level2">
<h2 class="anchored" data-anchor-id="exponential-distribution">Exponential distribution</h2>
<p>The exponential distribution is a continous probability distribution that describe the time taken for the first event of a Poisson process to happen.</p>
<p><span class="math display">\[
f(x; \lambda) = \lambda e^{-\lambda x}, \quad x \geq 0
\]</span></p>
<p>The only parameter of the exponential distribution is, as for the Poisson distribution, the <span class="math inline">\(\lambda\)</span>.</p>
<p>Using the cars example, an exponential distribution with <span class="math inline">\(\lambda = 10\)</span> means that for a unit time we expect on average that a car will take <span class="math inline">\(1/\lambda = 0.1\)</span> and with a rate of <span class="math inline">\(\lambda = 10\)</span> events per unit time.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcurve</span>(<span class="at">fun =</span> dexp, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">rate =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="understanding-gamma_files/figure-html/unnamed-chunk-4-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In fact, the mean of the exponential distribution is <span class="math inline">\(1/\lambda\)</span> because is like computing the unit time divided by the expected number of events. Unit time is 1 and the expected number of events is the rate (<span class="math inline">\(\lambda\)</span>) of the Poisson.</p>
</section>
<section id="gamma-distribution" class="level2">
<h2 class="anchored" data-anchor-id="gamma-distribution">Gamma distribution</h2>
<p>To sum up, the Poisson distribution describe a discrete process counting the number of independent events for a unit time with rate <span class="math inline">\(\lambda\)</span>. The Exponential distribution describe the average time taken for the first event to happen given the rate <span class="math inline">\(\lambda\)</span>.</p>
<p>What about if we have more than 1 event? When <span class="math inline">\(k &gt; 1\)</span> essentially we have a Gamma distribution.</p>
<p><span class="math display">\[
f(x; \alpha, \lambda) = \frac{x^{\alpha-1} e^{-\lambda x} \lambda^{\alpha}}{\Gamma(\alpha)}, \quad x &gt; 0, \quad \alpha, \lambda &gt; 0
\]</span></p>
<p>In this equation, <span class="math inline">\(\alpha = k\)</span> i.e.&nbsp;the usually called <em>shape</em> parameter is the number of events. If we fix <span class="math inline">\(\alpha = 1\)</span> the Gamma distribution reduces to an Exponential distribution. In practice the Exponential is a special type of Gamma with <span class="math inline">\(\alpha = 1\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcurve</span>(<span class="at">fun =</span> dgamma,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">args =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">1</span>, <span class="at">rate =</span> <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="understanding-gamma_files/figure-html/unnamed-chunk-5-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Sticking with our example, a Gamma distribution with rate <span class="math inline">\(\lambda = 10\)</span> and shape <span class="math inline">\(\alpha = 5\)</span> is about the time taken for <span class="math inline">\(k = 5\)</span> events to happen given the rate of 10 events per unit time.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcurve</span>(<span class="at">fun =</span> dgamma,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">args =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">10</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="understanding-gamma_files/figure-html/unnamed-chunk-6-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We will describe better the parametrization but if the time taken for 1 events to happen given <span class="math inline">\(\lambda = 10\)</span> is <span class="math inline">\(1/\lambda = 0.1\)</span>. The time taken for <span class="math inline">\(k = 5\)</span> events is just <span class="math inline">\(\frac{1}{\lambda} k = \frac{k}{\lambda}\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggcurve</span>(<span class="at">fun =</span> dgamma,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">args =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">10</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span> <span class="sc">*</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="understanding-gamma_files/figure-html/unnamed-chunk-7-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So the Gamma is just the sum of <span class="math inline">\(k\)</span> independent exponential distributions.</p>
<blockquote class="blockquote">
<p>Clearly, we can model whatever process respect the assumptions and not only time. But this is the natural intepretation given the link between Poisson, Exponential and Gamma.</p>
</blockquote>
<p>The problem is that when we have situation not directly related to time and poisson processes is less intuitive to think as in previous examples. For this reason we can use different type of Gamma parametrization. This is the main reason why the Gamma is so confusing because there are multiple parametrizations.</p>
<section id="shape-alpha-and-rate-lambda-parametrization" class="level3">
<h3 class="anchored" data-anchor-id="shape-alpha-and-rate-lambda-parametrization">Shape <span class="math inline">\(\alpha\)</span> and Rate <span class="math inline">\(\lambda\)</span> parametrization</h3>
<p>This is the parametrization that we discussed above. The properties of the Gamma distribution using this approach are:</p>
<ul>
<li>mean: <span class="math inline">\(\mu = \frac{\alpha}{\lambda}\)</span></li>
<li>variance: <span class="math inline">\(\sigma^2 = \frac{\alpha}{\lambda^2}\)</span> (similar to the Poisson)</li>
<li>standard deviation: <span class="math inline">\(\sigma = \frac{\sqrt{\alpha}}{\lambda}\)</span></li>
<li>skewness: <span class="math inline">\(\frac{2}{\sqrt{\alpha}}\)</span></li>
</ul>
<p>Notice some important aspects:</p>
<ul>
<li>as for the Poisson, mean and standard deviations are linked. When <span class="math inline">\(\mu = \frac{\alpha}{\lambda}\)</span> increase also <span class="math inline">\(\sigma = \frac{\sqrt{\alpha}}{\lambda}\)</span> increase</li>
<li>the relationship between mean and standard deviation is linear for the Poisson but not linear for the Gamma.</li>
</ul>
</section>
<section id="shape-alpha-and-scale-theta-parametrization" class="level3">
<h3 class="anchored" data-anchor-id="shape-alpha-and-scale-theta-parametrization">Shape <span class="math inline">\(\alpha\)</span> and Scale <span class="math inline">\(\theta\)</span> parametrization</h3>
<p>This is similar to the parametrizatio above but the scale parameter is defined as the reciprocal of the rate parameter thus <span class="math inline">\(\theta = 1/\lambda\)</span>.</p>
<ul>
<li>mean: <span class="math inline">\(\mu = \alpha\theta\)</span></li>
<li>variance: <span class="math inline">\(\sigma^2 = \alpha\theta^2\)</span></li>
<li>standard deviation: <span class="math inline">\(\sigma = \sqrt{\alpha}\theta\)</span></li>
<li>skewness: <span class="math inline">\(\frac{2}{\sqrt{\alpha}}\)</span></li>
</ul>
</section>
<section id="mu-and-shape-alpha-parametrization" class="level3">
<h3 class="anchored" data-anchor-id="mu-and-shape-alpha-parametrization"><span class="math inline">\(\mu\)</span> and shape <span class="math inline">\(\alpha\)</span> parametrization</h3>
<p>This is probably the most useful at least for modelling. In fact, in R thge default when dealing with the Gamma distribution per-se (<code>dgamma</code>, <code>rgamma</code>, etc.) is using the two parametrization above. While when fitting a GLM with a Gamma distribution the <code>glm</code> (but also <code>glmer</code>) function use the <span class="math inline">\(\mu\)</span> and shape <span class="math inline">\(\alpha\)</span> parametrization.</p>
<p>With this parametrization we need to do a little bit of math for fixing the mean and the shape and then finding the scale or rate to generate data using base R function.</p>
<p>But how to fix the shape? We are somehow losing the event/time logic of the beginning because we simply want a Gamma with a certain mean. A good way to think about the shape is in terms of skewness. The skewness depends only on the <span class="math inline">\(\alpha\)</span> parameter thus we can choose our Gamma fixing the mean and the desired level of skewness. Solving the equation for <span class="math inline">\(\alpha\)</span> we have <span class="math inline">\(\alpha = 4/s^2\)</span> (s is skewness). Then having <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\alpha\)</span> we can calculate <span class="math inline">\(\theta\)</span> or <span class="math inline">\(\lambda\)</span>. For example, using <span class="math inline">\(\lambda\)</span>, <span class="math inline">\(\lambda = \mu / \alpha\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>skew <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">/</span>skew<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> alpha <span class="sc">/</span> mu</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># theta &lt;- mu / alpha</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="fl">1e4</span>, <span class="at">shape =</span> alpha, <span class="at">rate =</span> lambda)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(y, <span class="at">breaks =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="understanding-gamma_files/figure-html/unnamed-chunk-8-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(y)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 99.4626</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(y)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 49.24929</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>psych<span class="sc">::</span><span class="fu">skew</span>(y)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.9619901</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s fit a GLM:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ 1, family = Gamma(link = "log"))

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 4.599782   0.004952     929   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Gamma family taken to be 0.2451774)

    Null deviance: 2557.8  on 9999  degrees of freedom
Residual deviance: 2557.8  on 9999  degrees of freedom
AIC: 104612

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>Given that we used the <code>log</code> link function, <span class="math inline">\(e^{\beta_0}\)</span> is <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\alpha = 1/\zeta\)</span> where <span class="math inline">\(\zeta\)</span> is the estimated dispersion parameter.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(fit)) <span class="co"># mean</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">## (Intercept) </span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">##     99.4626</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>zeta <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit)<span class="sc">$</span>dispersion</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span>zeta <span class="co"># alpha, shape</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 4.07868</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An important point that is not always clear is that the assumption of a standard glm model fitted with <code>glm</code> or <code>glmer</code> is that the shape parameter is the same for each observation. This is similar to a standard model where the residual variance is the same for each observation.</p>
<p>This can be relaxed using a so-called scale-location model (e.g., using <code>brms</code>) with predictors on the mean (as <code>glm</code>) and the shape parameters.</p>
</section>
<section id="mu-and-sigma2-parametrization" class="level3">
<h3 class="anchored" data-anchor-id="mu-and-sigma2-parametrization"><span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma^2\)</span> parametrization</h3>
<p>In this case, we fix the <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma^2\)</span> but we have no control on the skewness.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggamma</span>(<span class="at">mean =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">600</span>), <span class="at">sd =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="understanding-gamma_files/figure-html/unnamed-chunk-11-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gammap</span>(<span class="at">mean =</span> <span class="dv">500</span>, <span class="at">sd =</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$shape
[1] 6.25

$rate
[1] 0.0125

$scale
[1] 80

$cv
[1] 0.4

$skew
[1] 0.8

$mean
[1] 500

$sd
[1] 200</code></pre>
</div>
</div>
<p>In addition, let’s assume we want to simulate two groups with different mean and same variance as the plot above:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gammap</span>(<span class="at">mean =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">600</span>), <span class="at">sd =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$shape
[1] 6.25 9.00

$rate
[1] 0.0125 0.0150

$scale
[1] 80.00000 66.66667

$cv
[1] 0.4000000 0.3333333

$skew
[1] 0.8000000 0.6666667

$mean
[1] 500 600

$sd
[1] 200 200</code></pre>
</div>
</div>
<p>The shape is different between the two groups, and this is a violation of the assumption of the standard GLM similary to having different residual variances between conditions.</p>
<p>In fact, when we model this dataset with a GLM, the shape is not recovered:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pars <span class="ot">&lt;-</span> <span class="fu">gammap</span>(<span class="at">mean =</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">600</span>), <span class="at">sd =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="dv">200</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e3</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>g0 <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(n, <span class="at">shape =</span> pars<span class="sc">$</span>shape[<span class="dv">1</span>], <span class="at">scale =</span> pars<span class="sc">$</span>scale[<span class="dv">1</span>])</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(n, <span class="at">shape =</span> pars<span class="sc">$</span>shape[<span class="dv">2</span>], <span class="at">scale =</span> pars<span class="sc">$</span>scale[<span class="dv">2</span>])</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(g0, g1)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">each =</span> n)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ x, family = Gamma(link = "log"))

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  6.22003    0.01152  539.77   &lt;2e-16 ***
x            0.16309    0.01630   10.01   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Gamma family taken to be 0.13279)

    Null deviance: 285.59  on 1999  degrees of freedom
Residual deviance: 272.30  on 1998  degrees of freedom
AIC: 26673

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>The mean shift is correctly recovered:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ~ mean g0</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="dv">1</span>])</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="do">## (Intercept) </span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="do">##    502.7173</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ~ mean g1</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(fit)[<span class="dv">2</span>])</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="do">## (Intercept) </span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="do">##    591.7712</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ~ ratio</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="dv">2</span>]) <span class="co"># 600/500 = 1.2</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="do">##        x </span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 1.177145</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But the dispersion is not recovered:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>zeta <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit)<span class="sc">$</span>dispersion</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span>zeta <span class="co"># alpha, shape</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 7.530687</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(pars<span class="sc">$</span>shape) <span class="co"># ~ maybe</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 7.625</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="different-packages" class="level2">
<h2 class="anchored" data-anchor-id="different-packages">Different packages</h2>
<section id="brms" class="level3">
<h3 class="anchored" data-anchor-id="brms"><code>brms</code></h3>
<p><code>brms</code> use a mean-shape parametrization, especially when using a location-scale (i.e., distributional) model.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> <span class="fu">gammap</span>(<span class="at">mean =</span> <span class="dv">100</span>, <span class="at">sd =</span>  <span class="dv">50</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>pp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$shape
[1] 4

$rate
[1] 0.04

$scale
[1] 25

$cv
[1] 0.5

$skew
[1] 1

$mean
[1] 100

$sd
[1] 50</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">100</span>, <span class="at">shape =</span> pp<span class="sc">$</span>shape, <span class="at">scale =</span> pp<span class="sc">$</span>scale)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fit_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> dat, <span class="at">file =</span> <span class="st">"fit_brm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gamma 
  Links: mu = log; shape = identity 
Formula: y ~ 1 
   Data: dat (Number of observations: 100) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     4.59      0.05     4.49     4.69 1.00     3416     2586

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
shape     3.95      0.53     2.97     5.06 1.00     3387     2733

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>You can use also another link for the <code>shape</code> (usually log)</p>
</section>
<section id="glmglmer" class="level3">
<h3 class="anchored" data-anchor-id="glmglmer"><code>glm/glmer</code></h3>
<p><code>glm</code> or <code>glmer</code> use the <span class="math inline">\(\mu\)</span>-dispersion (<span class="math inline">\(\phi\)</span>) parametrization where dispersion is <span class="math inline">\(1/\alpha\)</span>. Using the same dataset:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fit_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dat, <span class="at">family =</span> <span class="fu">Gamma</span>(<span class="at">link =</span> <span class="st">"log"</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_glm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ 1, family = Gamma(link = "log"), data = dat)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  4.58679    0.04903   93.55   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Gamma family taken to be 0.2404142)

    Null deviance: 26.262  on 99  degrees of freedom
Residual deviance: 26.262  on 99  degrees of freedom
AIC: 1049.5

Number of Fisher Scoring iterations: 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_glm)<span class="sc">$</span>dispersion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2404142</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span><span class="fu">summary</span>(fit_glm)<span class="sc">$</span>dispersion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.159487</code></pre>
</div>
</div>
</section>
<section id="gamlss" class="level3">
<h3 class="anchored" data-anchor-id="gamlss"><code>gamlss</code></h3>
<p><code>gamlss</code> is a very complete package for scale-location modelling. The package use another parametrization. Basically what in the package is called <code>sigma</code> is <span class="math inline">\(\sqrt{\phi}\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gamlss)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>fit_gam <span class="ot">&lt;-</span> <span class="fu">gamlss</span>(y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dat, <span class="at">family =</span> <span class="fu">GA</span>(<span class="at">mu.link =</span> <span class="st">"log"</span>, <span class="at">sigma.link =</span> <span class="st">"identity"</span>)) <span class="co"># sigma.link can be also "log"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GAMLSS-RS iteration 1: Global Deviance = 1045.458 
GAMLSS-RS iteration 2: Global Deviance = 1045.458 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>******************************************************************
Family:  c("GA", "Gamma") 

Call:  gamlss(formula = y ~ 1, family = GA(mu.link = "log",  
    sigma.link = "identity"), data = dat) 

Fitting method: RS() 

------------------------------------------------------------------
Mu link function:  log
Mu Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  4.58679    0.05021   91.35   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

------------------------------------------------------------------
Sigma link function:  identity
Sigma Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.50209    0.03412   14.72   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

------------------------------------------------------------------
No. of observations in the fit:  100 
Degrees of Freedom for the fit:  2
      Residual Deg. of Freedom:  98 
                      at cycle:  2 
 
Global Deviance:     1045.458 
            AIC:     1049.458 
            SBC:     1054.668 
******************************************************************</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(fit_gam<span class="sc">$</span>sigma.coefficients) <span class="co"># same as summary(fit_glm)$dispersion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
  0.7085856 </code></pre>
</div>
</div>
<p>The variance of the Gamma is <span class="math inline">\(\sigma^2 = \phi^2 \mu^2\)</span> (see <code>?GA()</code>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(dat<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 48.139</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sqrt(dispersion)</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(fit_gam<span class="sc">$</span>sigma.coefficients<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">coef</span>(fit_gam))<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   49.29486 </code></pre>
</div>
</div>
</section>
</section>
<section id="note-about-the-link-function" class="level2">
<h2 class="anchored" data-anchor-id="note-about-the-link-function">Note about the link function</h2>
<p>The canonical link function for the Gamma is the <code>inverse</code>, while the most common is the <code>log</code>. By default, <code>glm</code> use the <code>inverse</code>. This change the parameters interpretation.</p>
<p>The default link for the <code>dispersion</code> is the <code>identity</code> (e.g., in <code>brms</code>) especially when there are no predictors on the shape or dispersion. With predictors, the usual link function is the <code>log</code> to avoid negative values.</p>
</section>
<section id="mean-variance-relationship" class="level2">
<h2 class="anchored" data-anchor-id="mean-variance-relationship">Mean-Variance relationship<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></h2>
<p>An important point is the mean-variance relationship that is common to all GLMs. For example in the poisson <span class="math inline">\(E[y] = \lambda\)</span> and <span class="math inline">\(V[y] = \lambda\)</span>.</p>
<p>In the Gamma distribution, for the shape-scale parametrization:</p>
<p><span class="math display">\[
E[y] = \mu = \alpha\theta
\]</span></p>
<p><span class="math display">\[
V[y] = \sigma^2 = \alpha\theta^2 = \mu\theta
\]</span></p>
<p>Thus if <span class="math inline">\(\mu\)</span> is 100, the variance is <span class="math inline">\(100\theta\)</span></p>
<p>For the shape-rate parametrization:</p>
<p><span class="math display">\[
E[y] = \mu = \frac{\alpha}{\lambda}
\]</span></p>
<p><span class="math display">\[
V[y] = \sigma^2 = \frac{\alpha}{\lambda^2} = \mu \frac{1}{\lambda} = \frac{\mu}{\lambda}
\]</span></p>
<p>It is very strange but the coefficient of variation defined as <span class="math inline">\(\sigma/\mu\)</span> depends only on <span class="math inline">\(\alpha\)</span> (stick with the shape-scale parametrization):</p>
<p><span class="math display">\[
CV = \frac{\sigma^2}{\mu} = \frac{\sqrt{\alpha\beta^2}}{\alpha\beta} = \frac{1}{\alpha}
\]</span></p>
<p><span class="math display">\[
\sigma = \mu CV \\
\sigma = \mu \frac{1}{\sqrt{\alpha}} = \frac{\mu}{\sqrt{\alpha}}
\]</span></p>
<p>So if the mean of the Gamma is 100, the standard deviation is <span class="math inline">\(\frac{100}{\sqrt{\alpha}}\)</span></p>
<p>Essentially, the relationship between the mean and the variance (or standard deviation) is adjustable compared to other probability distributions such as the Poisson.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>from <a href="https://civil.colorado.edu/~balajir/CVEN6833/lectures/c-czado-GLM-lectures/GammaGLM-01.pdf">https://civil.colorado.edu/~balajir/CVEN6833/lectures/c-czado-GLM-lectures/GammaGLM-01.pdf</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>